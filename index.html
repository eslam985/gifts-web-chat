<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>GiftsBot Web Chat</title>
 <!-- ØªØ­Ù…ÙŠÙ„ Tailwind CSS -->
 <script src="https://cdn.tailwindcss.com"></script>
 <!-- Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø· Inter ÙˆØ¨Ø¹Ø¶ Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
 <script>
  tailwind.config = {
   theme: {
    extend: {
     colors: {
      'primary-blue': '#4F46E5',
      'secondary-gray': '#F3F4F6',
      'bot-bubble': '#E0F2F1', // Teal Light
      'user-bubble': '#DCF8C6', // Light Green
     },
     fontFamily: {
      sans: ['Inter', 'Arial', 'sans-serif'],
     }
    }
   }
  }
 </script>
 <style>
  /* Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø³Ù„Ø³ */
  .chat-container {
   scroll-behavior: smooth;
  }

  /* ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
  #sendButton {
   transition: background-color 0.2s;
  }

  #sendButton:hover {
   background-color: #4338CA;
  }

  /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */
  .quick-reply-button {
   transition: all 0.2s;
   cursor: pointer;
  }

  .quick-reply-button:hover {
   box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
   transform: translateY(-1px);
  }
 </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen font-sans p-4">

 <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
 <div class="w-full max-w-lg h-[90vh] flex flex-col bg-white rounded-xl shadow-2xl overflow-hidden">

  <!-- Ø§Ù„Ø±Ø£Ø³ -->
  <header class="bg-primary-blue text-white p-4 flex items-center rounded-t-xl shadow-md">
   <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
     d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.693a9.76 9.76 0 01-1.346-4.307c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
   </svg>
   <h1 class="text-xl font-bold">Ø¨ÙˆØª Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (GiftsBot)</h1>
  </header>

  <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
  <div id="chatContainer" class="chat-container flex-grow p-4 space-y-4 overflow-y-auto bg-secondary-gray">
   <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù‡Ù†Ø§ -->
  </div>

  <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
  <div id="quickRepliesContainer"
   class="p-3 bg-white border-t border-gray-200 flex flex-wrap gap-2 justify-start items-center min-h-[4rem]">
   <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ù‡Ù†Ø§ -->
  </div>

  <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
  <div class="p-4 bg-white border-t border-gray-200 flex">
   <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."
    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue"
    onkeypress="if(event.key === 'Enter') document.getElementById('sendButton').click()">
   <button id="sendButton"
    class="mr-2 bg-primary-blue text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-400">
    Ø¥Ø±Ø³Ø§Ù„
   </button>
  </div>

 </div>

 <script>
  // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
  let sessionId = Date.now().toString(); // Ù„Ø¶Ù…Ø§Ù† Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ÙƒÙ„ ØªØ­Ù…ÙŠÙ„
  let webhookUrl = 'https://gifts-bot-webhook.vercel.app/webhook';
  let isWaitingForResponse = false;
  const chatContainer = document.getElementById('chatContainer');
  const userInput = document.getElementById('userInput');
  const sendButton = document.getElementById('sendButton');
  const quickRepliesContainer = document.getElementById('quickRepliesContainer');

  // ----------------------------------------------------------------
  // ÙˆØ¸Ø§Ø¦Ù DOM
  // ----------------------------------------------------------------

  /**
   * ØªØ¶ÙŠÙ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
   * @param {string} text - Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
   * @param {string} sender - 'user' Ø£Ùˆ 'bot'.
   * @param {string} [payload] - Ø­Ù…ÙˆÙ„Ø© Ø§Ù„Ø²Ø± Ø§Ù„Ø³Ø±ÙŠØ¹ (Quick Reply) Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡.
   */
  function addMessage(text, sender, payload = null) {
   const messageElement = document.createElement('div');
   messageElement.className = 'flex ' + (sender === 'user' ? 'justify-end' : 'justify-start');

   const bubble = document.createElement('div');
   bubble.className = 'max-w-xs lg:max-w-md px-4 py-2 rounded-xl shadow-md ' +
    (sender === 'user' ? 'bg-user-bubble text-gray-800 rounded-br-none' : 'bg-bot-bubble text-gray-800 rounded-tl-none');

   // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø§ØªØ¬Ø© Ø¹Ù† Ø¶ØºØ· Ø²Ø± Ø³Ø±ÙŠØ¹
   if (sender === 'user' && payload) {
    bubble.innerHTML = `<span class="text-sm italic text-gray-600">Ø§Ø®ØªÙŠØ§Ø±: </span><span class="font-medium">${text}</span>`;
   } else {
    bubble.textContent = text;
   }

   messageElement.appendChild(bubble);
   chatContainer.appendChild(messageElement);

   // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³ÙÙ„
   chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  /**
   * ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (Quick Replies) ÙÙŠ Ø­Ø§ÙˆÙŠØ© Ø®Ø§ØµØ©.
   * @param {Array<Object>} quickReplies - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±.
   */
  function displayQuickReplies(quickReplies) {
   // Ù…Ø³Ø­ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
   quickRepliesContainer.innerHTML = '';

   if (!quickReplies || quickReplies.length === 0) {
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£Ø²Ø±Ø§Ø±ØŒ Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø­Ø§ÙˆÙŠØ©
    quickRepliesContainer.style.display = 'none';
    return;
   }

   quickRepliesContainer.style.display = 'flex';

   quickReplies.forEach(reply => {
    const button = document.createElement('button');
    button.className = 'quick-reply-button bg-primary-blue text-white text-sm px-4 py-2 rounded-full font-semibold border-2 border-primary-blue';
    button.textContent = reply.title;

    // Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ø¶ØºØ· Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ù…ÙˆÙ„Ø© (payload)
    button.onclick = () => {
     // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ ÙƒÙ€ payload
     sendMessage(reply.title, true);
     // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ·
     quickRepliesContainer.style.display = 'none';
    };
    quickRepliesContainer.appendChild(button);
   });
   // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³ÙÙ„ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
   chatContainer.scrollTop = chatContainer.scrollHeight;
  }


  /**
   * ÙŠØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø¨Ø³ÙŠØ·Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
   * @param {string} message - Ù†Øµ Ø§Ù„Ø®Ø·Ø£.
   */
  function displayError(message) {
   const errorText = `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${message}`;
   addMessage(errorText, 'bot');
  }

  /**
   * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± ÙˆØ­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„.
   * @param {boolean} waiting - Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (ØµØ­ÙŠØ­/Ø®Ø·Ø£).
   */
  function setWaitingState(waiting) {
   isWaitingForResponse = waiting;
   sendButton.disabled = waiting;
   userInput.disabled = waiting;
   sendButton.textContent = waiting ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...' : 'Ø¥Ø±Ø³Ø§Ù„';
  }


  // ----------------------------------------------------------------
  // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Webhook
  // ----------------------------------------------------------------

  /**
   * Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Webhook Dialogflow Proxy.
   * @param {string} text - Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡.
   * @param {boolean} isQuickReply - Ù‡Ù„ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø³Ø±ÙŠØ¹ØŸ
   */
  async function sendMessage(text, isQuickReply = false) {
   if (isWaitingForResponse) return;
   if (!text.trim()) return;

   setWaitingState(true);

   // Ù…Ø³Ø­ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
   displayQuickReplies([]);

   // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
   addMessage(text, 'user', isQuickReply ? text : null);
   userInput.value = '';

   try {
    const response = await fetch(webhookUrl, {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
      // Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨ÙˆØ§Ø³Ø·Ø© Web Chat Proxy ÙÙŠ server.js
      queryText: text,
      sessionId: sessionId,
      source: 'web-chat'
     })
    });

    setWaitingState(false);

    if (!response.ok) {
     const errorBody = await response.json().catch(() => ({ fulfillmentText: 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… (HTTP ' + response.status + ')' }));
     const errorMessage = errorBody.fulfillmentText || `HTTP error! status: ${response.status}. Check Vercel logs for full error.`;
     console.error('Error communicating with Dialogflow Webhook:', new Error(errorMessage));
     displayError(errorMessage);
     return;
    }

    // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¯
    const data = await response.json();

    // Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    const fulfillmentText = data.fulfillmentText || 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ÙÙ‡Ù… Ø·Ù„Ø¨Ùƒ.';
    addMessage(fulfillmentText, 'bot');

    // ğŸ›‘ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØºÙ†ÙŠØ© (Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© - Quick Replies)
    if (data.fulfillmentMessages && Array.isArray(data.fulfillmentMessages)) {

     for (const message of data.fulfillmentMessages) {
      // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø­Ù…ÙˆÙ„Ø© Facebook Ø§Ù„ØªÙŠ ØªØ­Ù…Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
      if (message.platform === 'facebook' && message.payload?.facebook?.quick_replies) {
       displayQuickReplies(message.payload.facebook.quick_replies);
       break; // Ù†ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      }
     }
    }

   } catch (error) {
    setWaitingState(false);
    console.error('Fetch error:', error);
    displayError(error.message);
   }
  }

  // ----------------------------------------------------------------
  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  // ----------------------------------------------------------------
  document.addEventListener('DOMContentLoaded', () => {
   // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
   sendButton.addEventListener('click', () => sendMessage(userInput.value));

   // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
   sendMessage("/start");
  });
 </script>
</body>

</html>