<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>GiftsBot Web Chat</title>
 <script src="https://cdn.tailwindcss.com"></script>
 <style>
  body {
   font-family: sans-serif;
   background-color: #f3f4f6;
  }

  .chat-container {
   height: 80vh;
   overflow-y: auto;
  }

  .bot-msg {
   background-color: white;
   color: #374151;
   border-radius: 0.75rem;
   border-top-right-radius: 0;
  }

  .user-msg {
   background-color: #3b82f6;
   color: white;
   border-radius: 0.75rem;
   border-top-left-radius: 0;
  }

  .quick-btn {
   transition: all 0.2s;
  }

  .quick-btn:hover {
   transform: translateY(-2px);
  }
 </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">

 <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col h-[600px]">
  <header class="bg-blue-600 text-white p-4 font-bold text-lg flex justify-between items-center">
   <span>ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</span>
  </header>

  <div id="chat-messages" class="chat-container flex-1 p-4 space-y-4 bg-gray-50"></div>

  <div id="quick-replies" class="p-2 bg-gray-50 flex flex-wrap gap-2 justify-center min-h-[10px]"></div>

  <form id="chat-form" class="p-4 bg-white border-t flex gap-2">
   <input type="text" id="user-input"
    class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:border-blue-500" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."
    autocomplete="off">
   <button type="submit" class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
     class="w-6 h-6">
     <path stroke-linecap="round" stroke-linejoin="round"
      d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
    </svg>
   </button>
  </form>
 </div>

 <script>
  // ğŸ›‘ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§ Ù‡Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Webhook Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ
  const WEBHOOK_URL = "https://gifts-bot-webhook.vercel.app/webhook";

  let SESSION_ID = localStorage.getItem('chat_session_id');
  if (!SESSION_ID) {
   SESSION_ID = 'web-' + Math.random().toString(36).substr(2, 9);
   localStorage.setItem('chat_session_id', SESSION_ID);
  }

  const messagesContainer = document.getElementById('chat-messages');
  const quickRepliesContainer = document.getElementById('quick-replies');
  const userInput = document.getElementById('user-input');

  // ğŸ›‘ Ø¯Ø§Ù„Ø© Ø³Ø­Ø±ÙŠØ© Ù„ÙÙƒ ØªØ´ÙÙŠØ± Ù‡ÙŠÙƒÙ„ Google Protobuf Ø§Ù„Ù…Ø¹Ù‚Ø¯ Ø¥Ù„Ù‰ JSON Ø¹Ø§Ø¯ÙŠ
  function normalizeValue(value) {
   if (!value) return null;
   if (value.stringValue !== undefined) return value.stringValue;
   if (value.numberValue !== undefined) return value.numberValue;
   if (value.boolValue !== undefined) return value.boolValue;
   if (value.structValue) return normalizeStruct(value.structValue);
   if (value.listValue) return value.listValue.values.map(normalizeValue);
   return value;
  }

  function normalizeStruct(struct) {
   if (!struct || !struct.fields) return {};
   const result = {};
   for (const key in struct.fields) {
    result[key] = normalizeValue(struct.fields[key]);
   }
   return result;
  }

  function appendMessage(text, sender) {
   const div = document.createElement('div');
   div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
   div.innerHTML = `<div class="p-3 max-w-[80%] shadow-sm ${sender === 'user' ? 'user-msg' : 'bot-msg'}">${text.replace(/\n/g, '<br>')}</div>`;
   messagesContainer.appendChild(div);
   messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function renderQuickReplies(buttons) {
   quickRepliesContainer.innerHTML = '';
   if (!buttons || buttons.length === 0) return;

   buttons.forEach(btn => {
    const button = document.createElement('button');
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ÙƒÙ„ Ù…Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø³ÙŠØ· ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ù‚Ø¯
    const label = typeof btn === 'string' ? btn : (btn.title || btn.text);
    const payload = typeof btn === 'string' ? btn : (btn.payload || btn.text);

    button.textContent = label;
    button.className = "quick-btn bg-white border border-blue-500 text-blue-600 px-4 py-1 rounded-full text-sm font-medium hover:bg-blue-50";
    button.onclick = () => {
     sendMessage(payload);
     quickRepliesContainer.innerHTML = '';
    };
    quickRepliesContainer.appendChild(button);
   });
   messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  async function sendMessage(text) {
   if (!text.trim()) return;
   appendMessage(text, 'user');
   userInput.value = '';
   quickRepliesContainer.innerHTML = '';

   // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„
   const loadingDiv = document.createElement('div');
   loadingDiv.className = 'flex justify-start';
   loadingDiv.innerHTML = `<div class="bg-white text-gray-500 p-3 rounded-lg text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©...</div>`;
   messagesContainer.appendChild(loadingDiv);

   try {
    const response = await fetch(WEBHOOK_URL, {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
      source: 'web-chat',
      queryText: text,
      sessionId: SESSION_ID
     })
    });

    const data = await response.json();
    messagesContainer.removeChild(loadingDiv);

    if (data.fulfillmentMessages) {
     // 1. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØµÙˆØµ
     data.fulfillmentMessages.forEach(msg => {
      if (msg.text && msg.text.text) {
       appendMessage(msg.text.text[0], 'bot');
      }
     });

     // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ù…Ø¹ Ø¯Ø¹Ù… ÙÙƒ ØªØ´ÙÙŠØ± Protobuf)
     let buttons = [];

     data.fulfillmentMessages.forEach(msg => {
      // Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ù‚Ø¯Ø© (structValue)
      let payload = msg.payload;

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØªÙ†Ø³ÙŠÙ‚ Protobuf ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§
      if (payload && payload.fields) {
       payload = normalizeStruct(payload);
      }

      // Ø§Ù„Ø¢Ù† Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸ÙŠÙØ©
      if (payload && payload.facebook && payload.facebook.quick_replies) {
       buttons = payload.facebook.quick_replies;
      }
      // Ø¯Ø¹Ù… Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø°ÙŠ Ù‚Ø¯ ÙŠØ¸Ù‡Ø± Ø£Ø­ÙŠØ§Ù†Ø§Ù‹
      else if (msg.quickReplies && msg.quickReplies.quickReplies) {
       buttons = msg.quickReplies.quickReplies;
      }
     });

     if (buttons.length > 0) {
      renderQuickReplies(buttons);
     }
    } else if (data.fulfillmentText) {
     appendMessage(data.fulfillmentText, 'bot');
    }

   } catch (error) {
    if (messagesContainer.contains(loadingDiv)) messagesContainer.removeChild(loadingDiv);
    console.error(error);
    appendMessage("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.", 'bot');
   }
  }

  document.getElementById('chat-form').addEventListener('submit', (e) => {
   e.preventDefault();
   sendMessage(userInput.value);
  });

  // Ø§Ù„Ø¨Ø¯Ø¡
  sendMessage('/start');
 </script>
</body>

</html>