<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø¢Ù„ÙŠØ©</title>
  <!-- ØªØ­Ù…ÙŠÙ„ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Ø®Ø· Inter Ù„Ù„ÙˆØ¶ÙˆØ­ */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f4f6f9;
    }

    .chat-container {
      max-width: 480px;
      height: 90vh;
      margin: 20px auto;
      border-radius: 1.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .bot-message {
      background-color: #ffffff;
      border-radius: 1.25rem 1.25rem 1.25rem 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .user-message {
      background-color: #10b981;
      /* Ø²Ù…Ø±Ø¯ÙŠ */
      color: white;
      border-radius: 1.25rem 1.25rem 0.5rem 1.25rem;
    }

    #chat-messages {
      flex-grow: 1;
      padding: 1rem;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
  </style>
</head>

<body class="bg-gray-100 p-4">

  <script>
    // ğŸ›‘ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­ØªÙ…ÙŠØ©
    // ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Webhook Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø§Ù„ØµØ­ÙŠØ­ (gifts-bot-webhook.vercel.app)
    const DIALOGFLOW_WEBHOOK_URL = "https://gifts-bot-webhook.vercel.app/webhook";
    // ğŸ›‘ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­ØªÙ…ÙŠ: ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØªØ®Ø²ÙŠÙ†Ù‡ ÙÙŠ localStorage
    let CHAT_SESSION_ID;
    if (!localStorage.getItem('sessionId')) {
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯ ÙˆØªØ®Ø²ÙŠÙ†Ù‡
      localStorage.setItem('sessionId', Math.random().toString(36).substring(2, 15));
    }
    // Ù†Ù‚ÙˆÙ… Ø¨Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø®Ø²Ù† (Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ø£Ùˆ Ù‚Ø¯ÙŠÙ…Ø§Ù‹)
    CHAT_SESSION_ID = localStorage.getItem('sessionId');
    // --- Helper Functions ---

    /**
     * ÙŠÙ†Ø¸Ù Ø§Ù„Ù†Øµ Ù…Ù† Ø±Ù…ÙˆØ² Markdown.
     */
    const cleanText = (text) => {
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Markdown bold to HTML
        .replace(/\n/g, '<br>'); // New lines
    };

    /**
     * ÙŠØ¶ÙŠÙ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
     * @param {string} text - Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
     * @param {'user'|'bot'} sender - Ù…Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
     * @param {boolean} isLoading - Ù‡Ù„ Ù‡ÙŠ Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ØŸ
     * @returns {HTMLElement} - Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø±Ø³Ø§Ù„Ø©.
     */
    const appendMessage = (text, sender, isLoading = false) => {
      const chatMessages = document.getElementById('chat-messages');
      const messageWrapper = document.createElement('div');
      const isUser = sender === 'user';

      messageWrapper.className = `flex mb-4 ${isUser ? 'justify-end' : 'justify-start'}`;

      const messageBox = document.createElement('div');
      const baseClasses = 'max-w-[80%] p-3 text-sm shadow-md rounded-xl';

      if (isUser) {
        messageBox.className = `${baseClasses} bg-teal-500 text-white rounded-tr-none`;
      } else {
        messageBox.className = `${baseClasses} bg-gray-100 text-gray-700 rounded-tl-none`;
      }

      if (isLoading) {
        messageBox.innerHTML = `<span class="animate-pulse">${text}</span>`;
        messageBox.id = 'loading-message';
      } else {
        messageBox.innerHTML = cleanText(text);
      }

      messageWrapper.appendChild(messageBox);
      chatMessages.appendChild(messageWrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      return messageWrapper; // Ù„Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹
    };

    /**
     * ÙŠØ²ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.
     */
    const removeMessage = (messageElement) => {
      if (messageElement && messageElement.parentNode) {
        messageElement.parentNode.removeChild(messageElement);
      }
    };

    /**
     * ÙŠØ¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© (Ø¨Ø·Ø§Ù‚Ø§ØªØŒ Ø£Ø²Ø±Ø§Ø±ØŒ Ù†Øµ).
     * @param {Array} messages - Ù…ØµÙÙˆÙØ© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù€ Fulfillment.
     * @param {string} textBefore - Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ÙŠØ³Ø¨Ù‚ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØºÙ†ÙŠØ©.
     */
    const processFulfillmentMessages = (messages, textBefore = '') => {
      const chatMessages = document.getElementById('chat-messages');

      // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§ÙˆÙŠØ© Ù„Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØºÙ†ÙŠØ© (Ø§Ù„Ø¨ÙˆØª)
      const messageWrapper = document.createElement('div');
      messageWrapper.className = 'flex justify-start mb-4';

      const messageBox = document.createElement('div');
      messageBox.className = 'bot-message max-w-[80%] p-3 text-sm text-gray-700 shadow-md bg-gray-100 rounded-xl rounded-tl-none';

      let messageContent = textBefore ? `<p class="mb-2">${cleanText(textBefore)}</p>` : '';
      let quickRepliesHtml = '';

      messages.forEach(msg => {
        // 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©
        if (msg.text && msg.text.text && msg.text.text.length > 0) {
          messageContent += `<p class="mb-2">${cleanText(msg.text.text[0] || '')}</p>`;
        }

        // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØºÙ†ÙŠØ© (Messenger Card) - Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        if (msg.platform === 'facebook' && msg.card) {
          const card = msg.card;
          const cardHtml = `
                    <div class="bg-white border border-gray-200 p-3 rounded-lg shadow-inner mb-3">
                        <h4 class="font-bold text-base text-teal-600 mb-1">${card.title}</h4>
                        ${card.imageUri ? `<img src="${card.imageUri}" onerror="this.onerror=null;this.src='https://placehold.co/400x200/cccccc/333333?text=Product';" class="w-full h-auto rounded-md my-2" alt="${card.title}">` : ''}
                        <p class="text-sm text-gray-600">${cleanText(card.subtitle || '')}</p>
                        ${card.buttons ? card.buttons.map(btn =>
            `<a href="${btn.postback}" target="_blank" class="block w-full text-center mt-2 p-2 bg-teal-500 hover:bg-teal-600 text-white rounded-lg text-xs transition duration-150">${btn.text}</a>`
          ).join('') : ''}
                    </div>
                `;
          messageContent += cardHtml;
        }

        // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© (Telegram Inline Keyboard) Ùˆ Quick Replies (Facebook)
        const keyboard = (msg.platform === 'telegram' && msg.payload?.telegram?.reply_markup?.inline_keyboard) ? msg.payload.telegram.reply_markup.inline_keyboard : [];
        const quickReplies = (msg.platform === 'facebook' && msg.quickReplies?.quickReplies) ? msg.quickReplies.quickReplies : [];

        let buttons = [];
        if (keyboard.length > 0) {
          buttons = keyboard.flat().map(btn => ({ text: btn.text, data: btn.callback_data || btn.text }));
        } else if (quickReplies.length > 0) {
          buttons = quickReplies.map(replyText => ({ text: replyText, data: replyText }));
        }

        if (buttons.length > 0) {
          quickRepliesHtml += `<div class="mt-2 flex flex-wrap gap-2 pt-2 border-t border-gray-200">`;
          buttons.forEach(btn => {
            quickRepliesHtml += `<button 
                        class="quick-reply-btn bg-blue-500 text-white text-xs px-3 py-1 rounded-full hover:bg-blue-600 transition duration-150 shadow-md" 
                        data-text="${btn.data}">
                        ${btn.text}
                    </button>`;
          });
          quickRepliesHtml += `</div>`;
        }

      });

      messageBox.innerHTML = messageContent + quickRepliesHtml;
      messageWrapper.appendChild(messageBox);
      chatMessages.appendChild(messageWrapper);

      // Attach event listeners to quick reply buttons
      messageBox.querySelectorAll('.quick-reply-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const textToSend = e.target.getAttribute('data-text');
          if (textToSend) {
            sendMessage(textToSend);
          }
        });
      });

      // Scroll to the bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    /**
     * ÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù€ Webhook Proxy.
     * @param {string} text - Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØµÙŠØ© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„.
     */
    const sendMessage = async (text) => {
      if (!text.trim()) return;

      // 1. Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥ÙØ±Ø§Øº Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      appendMessage(text, 'user');
      document.getElementById('user-input').value = '';

      // 2. Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      const loadingMessageElement = appendMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¯...', 'bot', true);

      // 3. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø­Ù…ÙˆÙ„Ø© (Payload) - **Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯**
      const payload = {
        source: 'web-chat', // Ù…Ø¤Ø´Ø± Ù„Ù€ Webhook Ø¨Ø£Ù† Ø§Ù„Ø·Ù„Ø¨ Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        queryText: text,
        sessionId: CHAT_SESSION_ID,
      };

      try {
        const response = await fetch(DIALOGFLOW_WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† 200 OKØŒ Ø¥Ø±ÙØ¹ Ø®Ø·Ø£ Ù„ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ ÙÙŠ catch
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // 4. Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        removeMessage(loadingMessageElement);

        // 5. Ø¹Ø±Ø¶ Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ù€ messages)
        if (data && data.fulfillmentMessages) {
          const textBefore = data.fulfillmentText || '';
          processFulfillmentMessages(data.fulfillmentMessages, textBefore);
        } else if (data && data.fulfillmentText) {
          // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ø¨Ø³ÙŠØ·
          appendMessage(data.fulfillmentText, 'bot');
        } else {
          appendMessage("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ„Ù‚ Ø±Ø¯Ù‹Ø§ ÙˆØ§Ø¶Ø­Ù‹Ø§ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….", 'bot');
        }

      } catch (error) {
        console.error('Error communicating with Dialogflow Webhook:', error);

        // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        removeMessage(loadingMessageElement);
        appendMessage(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Webhook.`, 'bot');

      }
    };

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('chat-form');
      const input = document.getElementById('user-input');

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        sendMessage(input.value);
      });

      // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      sendMessage("/start");
    });
  </script>


  <!-- Chat Interface Structure -->
  <div class="chat-container bg-white border border-gray-300">
    <!-- Header -->
    <header class="bg-gray-800 text-white p-4 text-center rounded-t-2xl">
      <h1 class="text-xl font-bold">Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¢Ù„ÙŠ</h1>
      <p class="text-xs text-gray-400">ØªØ­Ø¯Ø« Ù…Ø¹ÙŠ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø·Ù„Ø¨</p>
    </header>

    <!-- Messages Area -->
    <div id="chat-messages" class="flex flex-col space-y-4 bg-gray-50 p-4">
      <!-- Messages will be injected here -->
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="flex justify-center items-center py-2 hidden">
      <div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-teal-500"></div>
      <span class="text-sm text-gray-500 mr-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¯...</span>
    </div>

    <!-- Input Form -->
    <form id="chat-form" class="flex p-4 border-t border-gray-200 bg-white rounded-b-2xl">
      <input type="text" id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."
        class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-150 text-sm"
        autocomplete="off" required>
      <button type="submit" id="send-button"
        class="bg-teal-600 hover:bg-teal-700 text-white font-bold p-3 rounded-xl mr-2 transition duration-150">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
          class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
        </svg>
      </button>
    </form>
  </div>
</body>

</html>