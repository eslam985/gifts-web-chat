<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Gifts Bot Chat UI</title>
 <!-- Tailwind CSS CDN for styling -->
 <script src="https://cdn.tailwindcss.com"></script>
 <!-- React and Babel CDNs -->
 <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
 <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
 <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

 <style>
  /* Custom Font */
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

  body {
   font-family: 'Cairo', sans-serif;
   background-color: #f3f4f6;
  }
 </style>
</head>

<body>

 <div id="root">
  <!-- React component will be rendered here -->
 </div>

 <!-- 
    =====================================================================================
    Start of React/JSX Code
    =====================================================================================
    -->
 <script type="text/babel">
  // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Lucide ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ù€ Inline SVG Ù„Ø­Ù„ Ø®Ø·Ø£ Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­

  const { useState, useEffect, useCallback } = React;

  // ğŸ›‘ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Webhook Ø§Ù„ÙØ¹Ù„ÙŠ (ØªÙ… ÙˆØ¶Ø¹Ù‡ Ù‡Ù†Ø§ Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)
  const FULFILLMENT_ENDPOINT_URL = 'https://gifts-bot-webhook.vercel.app/webhook';

  // =================================================================
  // Ø§Ù„Ù…ÙƒÙˆÙ† Ø§Ù„ÙØ±Ø¹ÙŠ: Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ Rich Content
  // =================================================================
  const ProductCard = ({ product }) => {
   const defaultImageUrl = "https://placehold.co/400x200/4F46E5/FFFFFF?text=Product+Image";
   const whatsappLink = `https://wa.me/201013080898?text=Ø£Ø±ØºØ¨%20ÙÙŠ%20Ø´Ø±Ø§Ø¡%20${product.name}`;

   // SVG Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (DollarSign)
   const DollarIcon = (props) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-dollar-sign">
     <line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
    </svg>
   );

   // SVG Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Send)
   const SendIcon = (props) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-send">
     <path d="m22 2-7 20-4-9-9-4Z" /><path d="M22 2 11 13" />
    </svg>
   );

   return (
    <div className="bg-white rounded-lg shadow-lg max-w-sm overflow-hidden border border-indigo-100 mx-auto">

     <div className="h-40 overflow-hidden bg-gray-100">
      <img
       src={product.imageUrl || defaultImageUrl}
       alt={product.name}
       className="w-full h-full object-cover transition-transform duration-300 hover:scale-[1.05]"
       onError={(e) => {
        e.target.onerror = null;
        e.target.src = defaultImageUrl;
       }}
      />
     </div>

     <div className="p-4 flex flex-col items-end text-right" dir="rtl">
      <h3 className="text-xl font-bold text-gray-800 mb-2">{product.name}</h3>
      <div className="space-y-1 text-sm text-gray-600 w-full">
       <p className="flex justify-end items-center">
        <DollarIcon className="ml-2 text-green-600 flex-shrink-0" />
        <span className="font-semibold text-green-700">{product.price} Ø¬Ù†ÙŠÙ‡</span>
        :Ø§Ù„Ø³Ø¹Ø±
       </p>
       <p className="text-xs text-gray-500 line-clamp-2">
        {product.description || "Ø§Ù„ÙˆØµÙ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠÙ‹Ø§."}
       </p>
      </div>

      <a
       href={whatsappLink}
       target="_blank"
       rel="noopener noreferrer"
       className="mt-4 w-full flex justify-center items-center px-4 py-2 bg-green-500 text-white font-semibold rounded-md shadow-md hover:bg-green-600 transition duration-150 transform hover:scale-[1.01]"
      >
       <SendIcon className="ml-2" />
       Ø§Ø·Ù„Ø¨ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¢Ù†
      </a>
     </div>
    </div>
   );
  };


  // =================================================================
  // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ù„Ù€ Fulfillment API
  // =================================================================
  const fetchFulfillmentResponse = async (query) => {

   const parseFulfillmentForReact = (text) => {
    // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    if (text && text.includes("Ù…Ø­ÙØ¸Ø©") && text.includes("Ø¬Ù†ÙŠÙ‡")) {
     const priceMatch = text.match(/Ø§Ù„Ø³Ø¹Ø±: \*?(\d+)\*? Ø¬Ù†ÙŠÙ‡/);
     return {
      type: 'PRODUCT_CARD',
      data: {
       name: "Ù…Ø­ÙØ¸Ø© Ø¬Ù„Ø¯ Ø±Ø¬Ø§Ù„ÙŠØ© ÙØ§Ø®Ø±Ø©",
       price: priceMatch ? priceMatch[1] : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
       description: 'Ù…Ø­ÙØ¸Ø© ÙŠØ¯ÙˆÙŠØ© Ø§Ù„ØµÙ†Ø¹ Ù…Ù† Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø¨ØªØµÙ…ÙŠÙ… Ù†Ø­ÙŠÙ ÙˆØ¹ØµØ±ÙŠ.',
       imageUrl: 'https://images.unsplash.com/photo-1628005322971-470a0c13d717?q=80&w=600&h=400&auto=format&fit=crop',
      }
     };
    }

    return {
     type: 'TEXT',
     data: {
      text: text,
      quickReplies: []
     }
    };
   };

   try {
    const response = await fetch(FULFILLMENT_ENDPOINT_URL, {
     method: 'POST',
     headers: {
      'Content-Type': 'application/json',
     },
     body: JSON.stringify({
      session: 'projects/gifts-bot/agent/custom-session-id',
      queryInput: {
       text: {
        text: query,
        languageCode: 'ar-EG',
       },
      },
      customPayload: {
       platform: 'CUSTOM_REACT_UI'
      }
     }),
    });

    if (!response.ok) {
     throw new Error(`Ø®Ø·Ø£ ${response.status}: ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….`);
    }

    const data = await response.json();
    const fulfillmentText = data.fulfillmentText || "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯ Ù†ØµÙŠ.";

    return parseFulfillmentForReact(fulfillmentText);

   } catch (error) {
    console.error("API Call FAILED:", error);
    return {
     type: 'TEXT',
     data: {
      text: `ğŸ›‘ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Webhook ÙŠØ¹Ù…Ù„ ÙˆØ£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­. Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${error.message}`
     }
    };
   }
  };


  // =================================================================
  // Ø§Ù„Ù…ÙƒÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  // =================================================================
  const App = () => {
   const [messages, setMessages] = useState([]);
   const [input, setInput] = useState('');
   const [isTyping, setIsTyping] = useState(false);
   const [placeholder, setPlaceholder] = useState('Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...');

   // SVG Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ù‚ÙŠØ¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚ (ShoppingBag)
   const BagIcon = (props) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-shopping-bag">
     <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4" /><line x1="3" x2="21" y1="6" y2="6" /><path d="M16 10a4 4 0 0 1-8 0" />
    </svg>
   );

   // SVG Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Zap (Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©)
   const ZapIcon = (props) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-zap">
     <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
    </svg>
   );

   // SVG Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
   const SendInputIcon = (props) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-send">
     <path d="m22 2-7 20-4-9-9-4Z" /><path d="M22 2 11 13" />
    </svg>
   );


   const handleSend = useCallback(async (query) => {
    const userQuery = query || input;
    if (userQuery.trim() === '') return;

    const userMessage = { id: Date.now(), text: userQuery, sender: 'user', type: 'TEXT', data: { text: userQuery } };
    setMessages((prev) => [...prev, userMessage]);
    setInput('');
    setIsTyping(true);
    setPlaceholder('Ø§Ù„Ø±ÙˆØ¨ÙˆØª ÙŠÙƒØªØ¨...');

    const fulfillmentResponse = await fetchFulfillmentResponse(userQuery);

    setIsTyping(false);
    setPlaceholder('Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...');

    const botMessage = {
     id: Date.now() + 1,
     sender: 'bot',
     type: fulfillmentResponse.type,
     data: fulfillmentResponse.data
    };

    setMessages((prev) => [...prev, botMessage]);

   }, [input]);

   const handleQuickReply = (text) => {
    handleSend(text);
   };

   const handleKeyDown = (e) => {
    if (e.key === 'Enter') {
     handleSend();
    }
   };

   useEffect(() => {
    setMessages([{
     id: 0,
     sender: 'bot',
     type: 'TEXT',
     data: {
      text: 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ù‡Ø°Ù‡ ÙˆØ§Ø¬Ù‡Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©. Ø¬Ø±Ø¨ Ø£Ù† ØªØ³Ø£Ù„: Ø³Ø¹Ø± Ù…Ø­ÙØ¸Ø© Ø¬Ù„Ø¯ Ø±Ø¬Ø§Ù„ÙŠØ©',
      quickReplies: ['Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…', 'Ø£ÙØ¶Ù„ Ø§Ù„ØªÙˆØµÙŠØ§Øª']
     }
    }]);
   }, []);

   useEffect(() => {
    const chatWindow = document.getElementById('chat-messages');
    if (chatWindow) {
     chatWindow.scrollTop = chatWindow.scrollHeight;
    }
   }, [messages]);

   const renderMessageContent = (message) => {
    if (message.type === 'PRODUCT_CARD') {
     return <ProductCard product={message.data} />;
    }
    return (
     <p className="text-gray-700 whitespace-pre-wrap">{message.data.text || message.text}</p>
    );
   };

   const lastBotMessage = messages.slice().reverse().find(m => m.sender === 'bot');
   const quickReplies = lastBotMessage?.data?.quickReplies || [];


   return (
    <div dir="rtl" className="flex justify-center items-center min-h-screen bg-gray-50 p-4 font-sans">
     <div className="w-full max-w-lg h-[90vh] flex flex-col bg-white rounded-xl shadow-2xl overflow-hidden border border-indigo-200">

      {/* Ø±Ø£Ø³ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */}
      <header className="flex items-center p-4 bg-indigo-600 text-white shadow-md">
       <BagIcon className="ml-3" />
       <h1 className="text-lg font-bold">Ø¨ÙˆØª Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (React Custom UI)</h1>
      </header>

      {/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */}
      <div id="chat-messages" className="flex-1 p-4 space-y-4 overflow-y-auto bg-gray-100">
       {messages.map((message) => (
        <div
         key={message.id}
         className={`flex ${message.sender === 'user' ? 'justify-start' : 'justify-end'}`}
        >
         <div className={`max-w-[75%] p-3 rounded-xl shadow-sm ${message.sender === 'user'
           ? 'bg-indigo-500 text-white rounded-tr-none'
           : (message.type === 'PRODUCT_CARD' ? 'p-0 bg-transparent' : 'bg-white text-gray-800 rounded-tl-none border border-gray-200')
          }`}>
          {renderMessageContent(message)}
         </div>
        </div>
       ))}

       {/* Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© */}
       {isTyping && (
        <div className="flex justify-end">
         <div className="max-w-[75%] p-3 rounded-xl bg-white text-gray-800 rounded-tl-none border border-gray-200">
          <div className="typing-indicator flex space-x-1 items-center">
           <span className="dot dot-1 bg-indigo-500"></span>
           <span className="dot dot-2 bg-indigo-500"></span>
           <span className="dot dot-3 bg-indigo-500"></span>
          </div>
         </div>
        </div>
       )}
      </div>

      {/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */}
      {quickReplies.length > 0 && (
       <div className="p-3 bg-white border-t border-gray-200 flex flex-wrap justify-end gap-2">
        {quickReplies.map((reply, index) => (
         <button
          key={index}
          onClick={() => handleQuickReply(reply)}
          className="px-3 py-1 text-sm bg-indigo-50 border border-indigo-300 text-indigo-700 rounded-full hover:bg-indigo-100 transition duration-150 shadow-sm flex items-center"
         >
          <ZapIcon className="ml-1 text-yellow-500" />
          {reply}
         </button>
        ))}
       </div>
      )}


      {/* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */}
      <div className="p-4 bg-white border-t border-gray-200">
       <div className="flex space-x-2" dir="ltr">
        <input
         type="text"
         className="flex-1 w-full border border-gray-300 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right text-gray-700"
         value={input}
         onChange={(e) => setInput(e.target.value)}
         onKeyDown={handleKeyDown}
         placeholder={placeholder}
         dir="rtl"
         disabled={isTyping}
        />
        <button
         onClick={() => handleSend()}
         className={`p-3 rounded-lg text-white transition duration-150 ${input.trim() && !isTyping ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-gray-400 cursor-not-allowed'
          }`}
         disabled={!input.trim() || isTyping}
        >
         <SendInputIcon className="transform -scale-x-100" />
        </button>
       </div>
      </div>

     </div>
     {/* CSS Ù„Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© */}
     <style>{`
                        .typing-indicator .dot {
                            width: 8px;
                            height: 8px;
                            border-radius: 50%;
                            background-color: #333;
                            opacity: 0;
                            animation: bounce 1.4s infinite ease-in-out;
                        }
                        .typing-indicator .dot-1 { animation-delay: -0.32s; }
                        .typing-indicator .dot-2 { animation-delay: -0.16s; }
                        .typing-indicator .dot-3 { animation-delay: 0s; }
                        @keyframes bounce {
                            0%, 80%, 100% { transform: scale(0); opacity: 0; }
                            40% { transform: scale(1); opacity: 1; }
                        }
                    `}</style>
    </div>
   );
  };

  // Render the App component
  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
 </script>
</body>

</html>