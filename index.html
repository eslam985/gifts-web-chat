<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gifts Bot Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f7f9fc;
    }

    #chat-window {
      height: 85vh;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    /* Custom scrollbar for aesthetics */
    #chat-window::-webkit-scrollbar {
      width: 8px;
    }

    #chat-window::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 4px;
    }
  </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-lg bg-white rounded-xl shadow-2xl overflow-hidden">
    <!-- Chat Header -->
    <header class="bg-teal-600 text-white p-4 flex items-center justify-between">
      <h1 class="text-xl font-bold">ğŸ¤– Ø¨ÙˆØª Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø°ÙƒÙŠ</h1>
      <div class="text-sm">Dialogflow ES</div>
    </header>

    <!-- Chat Messages Window -->
    <div id="chat-messages-container" class="p-4" style="height: 60vh;">
      <div id="chat-messages" class="h-full overflow-y-auto space-y-4">
        <!-- Messages will be injected here -->
      </div>
    </div>

    <!-- User Input Form -->
    <div class="p-4 border-t border-gray-200 bg-gray-50">
      <form id="chat-form" class="flex gap-2">
        <input type="text" id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."
          class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-teal-500 focus:border-teal-500 transition duration-150"
          autocomplete="off" required>
        <button type="submit"
          class="bg-teal-500 hover:bg-teal-600 text-white p-3 rounded-xl shadow-lg transition duration-150 transform hover:scale-105">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </button>
      </form>
    </div>
  </div>
<!-- Test deployment successful -->
  <script>
    // ğŸ›‘ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­ØªÙ…ÙŠØ©
    // *** Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù„Ù„Ø§ÙØªØ±Ø§Ø¶ Ø¨Ø£Ù†Ù‡ ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù…ÙŠØ© ÙÙŠ Ù†Ø´Ø± ÙˆØ§Ø­Ø¯.
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø®Ø§Ø¯Ù… Webhook Ù„Ø§ ÙŠØ²Ø§Ù„ Ø¹Ù„Ù‰ gifts-bot-webhook.vercel.appØŒ Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹.
    const DIALOGFLOW_WEBHOOK_URL = "https://gifts-web-chat-o2ry9u763-eslams-projects-bd8f5f6d.vercel.app/webhook";
    // ğŸ›‘ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­ØªÙ…ÙŠ: ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØªØ®Ø²ÙŠÙ†Ù‡ ÙÙŠ localStorage
    let CHAT_SESSION_ID;
    if (!localStorage.getItem('sessionId')) {
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯ ÙˆØªØ®Ø²ÙŠÙ†Ù‡
      localStorage.setItem('sessionId', Math.random().toString(36).substring(2, 15));
    }
    // Ù†Ù‚ÙˆÙ… Ø¨Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø®Ø²Ù† (Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ø£Ùˆ Ù‚Ø¯ÙŠÙ…Ø§Ù‹)
    CHAT_SESSION_ID = localStorage.getItem('sessionId');
    // --- Helper Functions ---

    /**
     * ÙŠÙ†Ø¸Ù Ø§Ù„Ù†Øµ Ù…Ù† Ø±Ù…ÙˆØ² Markdown.
     */
    const cleanText = (text) => {
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Markdown bold to HTML
        .replace(/\n/g, '<br>'); // New lines
    };

    /**
     * ÙŠØ¶ÙŠÙ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
     * @param {string} text - Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
     * @param {'user'|'bot'} sender - Ù…Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
     * @param {boolean} isLoading - Ù‡Ù„ Ù‡ÙŠ Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ØŸ
     * @returns {HTMLElement} - Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø±Ø³Ø§Ù„Ø©.
     */
    const appendMessage = (text, sender, isLoading = false) => {
      const chatMessages = document.getElementById('chat-messages');
      const messageWrapper = document.createElement('div');
      const isUser = sender === 'user';

      messageWrapper.className = `flex mb-4 ${isUser ? 'justify-end' : 'justify-start'}`;

      const messageBox = document.createElement('div');
      const baseClasses = 'max-w-[80%] p-3 text-sm shadow-md rounded-xl';

      if (isUser) {
        messageBox.className = `${baseClasses} bg-teal-500 text-white rounded-tr-none`;
      } else {
        messageBox.className = `${baseClasses} bg-gray-100 text-gray-700 rounded-tl-none`;
      }

      if (isLoading) {
        messageBox.innerHTML = `<span class="animate-pulse">${text}</span>`;
        messageBox.id = 'loading-message';
      } else {
        messageBox.innerHTML = cleanText(text);
      }

      messageWrapper.appendChild(messageBox);
      chatMessages.appendChild(messageWrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom

      return messageWrapper; // Ù„Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹
    };

    /**
     * ÙŠØ²ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.
     */
    const removeMessage = (messageElement) => {
      if (messageElement && messageElement.parentNode) {
        messageElement.parentNode.removeChild(messageElement);
      }
    };

    /**
     * ÙŠØ¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© (Ø¨Ø·Ø§Ù‚Ø§ØªØŒ Ø£Ø²Ø±Ø§Ø±ØŒ Ù†Øµ).
     * @param {Array} messages - Ù…ØµÙÙˆÙØ© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù€ Fulfillment.
     * @param {string} textBefore - Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ÙŠØ³Ø¨Ù‚ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØºÙ†ÙŠØ©.
     */
    const processFulfillmentMessages = (messages, textBefore = '') => {
      const chatMessages = document.getElementById('chat-messages');

      // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§ÙˆÙŠØ© Ù„Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØºÙ†ÙŠØ© (Ø§Ù„Ø¨ÙˆØª)
      const messageWrapper = document.createElement('div');
      messageWrapper.className = 'flex justify-start mb-4';

      const messageBox = document.createElement('div');
      messageBox.className = 'bot-message max-w-[80%] p-3 text-sm text-gray-700 shadow-md bg-gray-100 rounded-xl rounded-tl-none';

      let messageContent = textBefore ? `<p class="mb-2">${cleanText(textBefore)}</p>` : '';
      let quickRepliesHtml = '';

      messages.forEach(msg => {
        // 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©
        if (msg.text && msg.text.text && msg.text.text.length > 0) {
          messageContent += `<p class="mb-2">${cleanText(msg.text.text[0] || '')}</p>`;
        }

        // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØºÙ†ÙŠØ© (Messenger Card) - Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        if (msg.platform === 'facebook' && msg.card) {
          const card = msg.card;
          const cardHtml = `
                                <div class="bg-white border border-gray-200 p-3 rounded-lg shadow-inner mb-3">
                                    <h4 class="font-bold text-base text-teal-600 mb-1">${card.title}</h4>
                                    ${card.imageUri ? `<img src="${card.imageUri}" onerror="this.onerror=null;this.src='https://placehold.co/400x200/cccccc/333333?text=Product';" class="w-full h-auto rounded-md my-2" alt="${card.title}">` : ''}
                                    <p class="text-sm text-gray-600">${cleanText(card.subtitle || '')}</p>
                                    ${card.buttons ? card.buttons.map(btn =>
            `<a href="${btn.postback}" target="_blank" class="block w-full text-center mt-2 p-2 bg-teal-500 hover:bg-teal-600 text-white rounded-lg text-xs transition duration-150">${btn.text}</a>`
          ).join('') : ''}
                                </div>
                            `;
          messageContent += cardHtml;
        }

        // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© (Telegram Inline Keyboard) Ùˆ Quick Replies (Facebook)
        const keyboard = (msg.platform === 'telegram' && msg.payload?.telegram?.reply_markup?.inline_keyboard) ? msg.payload.telegram.reply_markup.inline_keyboard : [];
        const quickReplies = (msg.platform === 'facebook' && msg.quickReplies?.quickReplies) ? msg.quickReplies.quickReplies : [];

        let buttons = [];
        if (keyboard.length > 0) {
          buttons = keyboard.flat().map(btn => ({ text: btn.text, data: btn.callback_data || btn.text }));
        } else if (quickReplies.length > 0) {
          buttons = quickReplies.map(replyText => ({ text: replyText, data: replyText }));
        }

        if (buttons.length > 0) {
          quickRepliesHtml += `<div class="mt-2 flex flex-wrap gap-2 pt-2 border-t border-gray-200">`;
          buttons.forEach(btn => {
            quickRepliesHtml += `<button 
                                        class="quick-reply-btn bg-blue-500 text-white text-xs px-3 py-1 rounded-full hover:bg-blue-600 transition duration-150 shadow-md" 
                                        data-text="${btn.data}">
                                        ${btn.text}
                                    </button>`;
          });
          quickRepliesHtml += `</div>`;
        }

      });

      messageBox.innerHTML = messageContent + quickRepliesHtml;
      messageWrapper.appendChild(messageBox);
      chatMessages.appendChild(messageWrapper);

      // Attach event listeners to quick reply buttons
      messageBox.querySelectorAll('.quick-reply-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const textToSend = e.target.getAttribute('data-text');
          if (textToSend) {
            sendMessage(textToSend);
          }
        });
      });

      // Scroll to the bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    /**
     * ÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù€ Webhook Proxy.
     * @param {string} text - Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØµÙŠØ© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„.
     */
    const sendMessage = async (text) => {
      if (!text.trim()) return;

      // 1. Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥ÙØ±Ø§Øº Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      appendMessage(text, 'user');
      document.getElementById('user-input').value = '';

      // 2. Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      const loadingMessageElement = appendMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¯...', 'bot', true);

      // 3. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø­Ù…ÙˆÙ„Ø© (Payload) - **Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯**
      const payload = {
        source: 'web-chat', // Ù…Ø¤Ø´Ø± Ù„Ù€ Webhook Ø¨Ø£Ù† Ø§Ù„Ø·Ù„Ø¨ Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        queryText: text,
        sessionId: CHAT_SESSION_ID,
      };

      try {
        const response = await fetch(DIALOGFLOW_WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† 200 OKØŒ Ø¥Ø±ÙØ¹ Ø®Ø·Ø£ Ù„ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ ÙÙŠ catch
          const errorBody = await response.text();
          console.error('HTTP Error Body:', errorBody);
          throw new Error(`HTTP error! status: ${response.status}. Check Vercel logs for full error.`);
        }

        const data = await response.json();

        // 4. Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        removeMessage(loadingMessageElement);

        // 5. Ø¹Ø±Ø¶ Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ù€ messages)
        if (data && data.fulfillmentMessages) {
          const textBefore = data.fulfillmentText || '';
          processFulfillmentMessages(data.fulfillmentMessages, textBefore);
        } else if (data && data.fulfillmentText) {
          // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ø¨Ø³ÙŠØ·
          appendMessage(data.fulfillmentText, 'bot');
        } else {
          appendMessage("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ„Ù‚ Ø±Ø¯Ù‹Ø§ ÙˆØ§Ø¶Ø­Ù‹Ø§ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….", 'bot');
        }

      } catch (error) {
        console.error('Error communicating with Dialogflow Webhook:', error);

        // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        removeMessage(loadingMessageElement);
        appendMessage(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Webhook.`, 'bot');

      }
    };

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('chat-form');
      const input = document.getElementById('user-input');

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        sendMessage(input.value);
      });

      // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      sendMessage("/start");
    });
  </script>
</body>

</html>